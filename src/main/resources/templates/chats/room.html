<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title th:text="${event.name} + ' - –ß–∞—Ç'">–ß–∞—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</title>
    <style>
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 80vh;
        }
        .messages-container {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .messages-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 500px;
        }
        .message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            max-width: 70%;
        }
        .message.own {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.other {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
        }
        .message-header {
            font-size: 0.8rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .tasks-section, .checklist-section {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item, .checklist-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item:hover, .checklist-item:hover {
            background: #f8f9fa;
        }
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .template-modal {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        /* –ë–ê–ó–û–í–´–ô –û–¢–°–¢–£–ü (–¥–ª—è 0-1 —ç–ª–µ–º–µ–Ω—Ç–æ–≤) */
        .footer-custom {
            margin-top: 210px !important; /* –±–∞–∑–æ–≤—ã–π –æ—Ç—Å—Ç—É–ø */
            padding-top: 2rem;
            padding-bottom: 2rem;
            transition: margin-top 0.3s ease; /* –ø–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ */
        }

        .chat-page-container {
            min-height: calc(100vh - 100px);
            padding-bottom: 100px !important;
        }

        .checklist-items-container {
            height: 140px !important;
            overflow-y: auto !important;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 th:text="${event.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h1>
                <p class="text-muted mb-0" th:text="'–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ' + ${event.participants.size()}">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</p>
            </div>
            <a th:href="@{/chats}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ —á–∞—Ç–∞–º
            </a>
        </div>

        <div class="chat-container">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
            <div class="messages-container">
                <div class="messages-list" id="messagesList">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                    <div th:each="message : ${chatMessages}"
                         th:data-message-id="${message.id}"
                         th:class="'message ' + (${message.author} == ${currentUser.username} ? 'own' : 'other')">
                        <div class="message-header">
                            <strong th:text="${message.author}">User</strong>
                            <span class="ms-2" th:text="${#temporals.format(message.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 12:00</span>
                            <span th:if="${message.edited}" class="ms-2">
                <small>(—Ä–µ–¥.)</small>
            </span>
                        </div>
                        <div class="message-content" th:text="${message.content}">Message content</div>

                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div th:if="${message.images != null and !message.images.isEmpty()}"
                             class="message-images mt-2">
                            <div th:each="image : ${message.images}" class="d-inline-block me-2 mb-2">
                                <a th:href="@{${image.url}}" target="_blank">
                                    <img th:src="@{${image.url}}"
                                         th:alt="${image.originalFilename}"
                                         class="img-thumbnail"
                                         style="max-width: 200px; max-height: 150px;">
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div th:if="${#lists.isEmpty(chatMessages)}" class="empty-state">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ</p>
                        <p class="small">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                </div>

                <div class="message-input">
                    <form id="messageForm">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="input-group mb-2">
                            <textarea id="messageInput" class="form-control"
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                      rows="2" required maxlength="1000"></textarea>
                            <button type="submit" class="btn btn-primary" id="sendMessage">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('imageUpload').click()">
                                    <i class="fas fa-image"></i> –§–æ—Ç–æ
                                </button>
                                <span id="imagePreview" class="ms-2"></span>
                            </div>
                            <small class="text-muted"><span id="messageCounter">0</span>/1000</small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∑–∞–¥–∞—á–∞–º–∏ –∏ —Å–ø–∏—Å–∫–æ–º -->
            <div class="side-panel">
                <!-- –ó–∞–¥–∞—á–∏ -->
                <div class="tasks-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks text-primary me-2"></i>–ó–∞–¥–∞—á–∏
                        </h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="filter-buttons">
                        <button class="btn btn-sm btn-outline-primary active filter-btn" data-type="task" data-filter="all">
                            –í—Å–µ
                        </button>
                        <button class="btn btn-sm btn-outline-primary filter-btn" data-type="task" data-filter="my">
                            –ú–æ–∏
                        </button>
                        <button class="btn btn-sm btn-outline-primary filter-btn" data-type="task" data-filter="active">
                            –ê–∫—Ç–∏–≤–Ω—ã–µ
                        </button>
                    </div>

                    <div id="tasksList">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π -->
                <div class="checklist-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-list-check text-success me-2"></i>–°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-success me-1" data-bs-toggle="modal" data-bs-target="#addChecklistModal">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#templatesModal">
                                <i class="fas fa-clipboard-list"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filter-buttons">
                        <button class="btn btn-sm btn-outline-success active filter-btn" data-type="checklist" data-filter="all">
                            –í—Å–µ
                        </button>
                        <button class="btn btn-sm btn-outline-success filter-btn" data-type="checklist" data-filter="my">
                            –ú–æ–∏
                        </button>
                        <button class="btn btn-sm btn-outline-success filter-btn" data-type="checklist" data-filter="active">
                            –ê–∫—Ç–∏–≤–Ω—ã–µ
                        </button>
                    </div>

                    <div id="checklistList">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                            <textarea class="form-control" name="description" required
                                      placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É..." maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</label>
                            <select class="form-select" name="assignedUserId">
                                <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</option>
                                <option th:each="user : ${participants}"
                                        th:value="${user.id}"
                                        th:text="${user.username}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞ -->
    <div class="modal fade" id="addChecklistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checklistForm">
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" name="name" required
                                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" name="description"
                                      placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞" maxlength="200"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="form-control" name="quantity" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</label>
                            <select class="form-select" name="assignedUserId">
                                <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</option>
                                <option th:each="user : ${participants}"
                                        th:value="${user.id}"
                                        th:text="${user.username}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-success" onclick="addChecklistItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞ -->
    <div class="modal fade" id="templatesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body template-modal">
                    <div id="templatesList">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script th:inline="javascript">
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const eventId = /*[[${event.id}]]*/ null;
        const currentUserId = /*[[${currentUser.id}]]*/ null;
        const currentUsername = /*[[${currentUser.username}]]*/ 'user';
        let stompClient = null;
        let selectedImages = [];

        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ room.html
        async function checkAndDisplayMessageWithImages(messageId) {
            console.log('Checking message', messageId, 'for images...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
            for (let attempt = 1; attempt <= 10; attempt++) {
                try {
                    console.log(`Attempt ${attempt} for message ${messageId}...`);

                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
                    const response = await fetch(`/api/v1/chat/message/${messageId}/full`);
                    if (response.ok) {
                        const message = await response.json();
                        console.log('Got message with images:', message);

                        if (message.images && message.images.length > 0) {
                            console.log(`Found ${message.images.length} images!`);

                            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                            let messageElement = document.querySelector(`[data-message-id="${messageId}"]`);

                            if (!messageElement) {
                                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                                addMessageToChat(message);
                            } else {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
                                updateMessageWithImages(messageElement, message);
                            }

                            return true; // –£—Å–ø–µ—Ö
                        }
                    }

                    // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
                    await new Promise(resolve => setTimeout(resolve, 300));

                } catch (error) {
                    console.error('Check error:', error);
                }
            }

            console.log('Images not found after 10 attempts');
            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function updateMessageWithImages(messageElement, message) {
            const isOwn = message.author === currentUsername;

            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            let imagesHtml = '';
            if (message.images && message.images.length > 0) {
                imagesHtml = '<div class="message-images mt-2">';
                message.images.forEach(img => {
                    imagesHtml += `
                <div class="d-inline-block me-2 mb-2">
                    <a href="${img.url}" target="_blank">
                        <img src="${img.url}"
                             class="img-thumbnail"
                             style="max-width: 200px; max-height: 150px;"
                             alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    </a>
                </div>`;
                });
                imagesHtml += '</div>';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messageElement.innerHTML = `
        <div class="message-header">
            <strong>${message.author}</strong>
            <span class="ms-2">${new Date(message.createdAt).toLocaleString()}</span>
            ${message.edited ? '<small class="ms-2">(—Ä–µ–¥.)</small>' : ''}
        </div>
        <div class="message-content">${message.content}</div>
        ${imagesHtml}
    `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadMessages();
            loadTasks();
            loadChecklist();
            loadTemplates();
            setupEventListeners();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            setupImageUpload();
        });

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function connectToImageUpdates(eventId) {
            const imageSocket = new SockJS('/ws');
            const stompClient = Stomp.over(imageSocket);

            stompClient.connect({}, function(frame) {
                console.log('Connected to image updates: ' + frame);

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                stompClient.subscribe('/topic/chat/' + eventId + '/images', function(message) {
                    const imageData = JSON.parse(message.body);

                    if (imageData.type === 'IMAGE_ADDED') {
                        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID
                        const messageElement = document.querySelector(`[data-message-id="${imageData.messageId}"]`);
                        if (messageElement) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            addImageToMessageElement(messageElement, imageData.image);
                        } else {
                            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å —á–∞—Ç
                            loadChatMessages();
                        }
                    }
                });
            });

            return stompClient;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        function addImageToMessageElement(messageElement, imageData) {
            const imagesContainer = messageElement.querySelector('.message-images');
            if (!imagesContainer) {
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                const container = document.createElement('div');
                container.className = 'message-images mt-2';
                messageElement.appendChild(container);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imgElement = document.createElement('div');
            imgElement.className = 'message-image mb-2';
            imgElement.innerHTML = `
        <a href="${imageData.url}" target="_blank">
            <img src="${imageData.url}" alt="${imageData.originalFilename}"
                 class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
        </a>
    `;

            imagesContainer.appendChild(imgElement);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showToast(message, type = 'success') {
            // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Bootstrap toast –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
            document.body.appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 3000);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const messageForm = document.getElementById('messageForm');

            imageUpload.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('imagePreview');

                preview.innerHTML = '';
                selectedImages = [];

                if (files.length > 5) {
                    alert('–ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞ —Ä–∞–∑');
                    this.value = '';
                    return;
                }

                files.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        if (file.size > 10 * 1024 * 1024) {
                            alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB`);
                            return;
                        }

                        selectedImages.push(file);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const container = document.createElement('div');
                            container.className = 'd-inline-block me-2 mb-2 position-relative';
                            container.innerHTML = `
                                <img src="${e.target.result}"
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;"
                                     alt="–ü—Ä–µ–≤—å—é">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 p-0"
                                        style="width: 20px; height: 20px; font-size: 10px;"
                                        onclick="removeImage(${index})">
                                    √ó
                                </button>
                            `;
                            preview.appendChild(container);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert(`–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);
                    }
                });

                // –û—á–∏—â–∞–µ–º input —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–µ –∂–µ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞
                this.value = '';
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            messageForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const messageInput = document.getElementById('messageInput');
                const messageContent = messageInput.value.trim();

                if (!messageContent && selectedImages.length === 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }

                await sendMessageWithImages(messageContent);
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        window.removeImage = function(index) {
            selectedImages.splice(index, 1);
            document.getElementById('imagePreview').innerHTML = '';

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            selectedImages.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.createElement('div');
                    container.className = 'd-inline-block me-2 mb-2 position-relative';
                    container.innerHTML = `
                        <img src="${e.target.result}"
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;"
                             alt="–ü—Ä–µ–≤—å—é">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 p-0"
                                style="width: 20px; height: 20px; font-size: 10px;"
                                onclick="removeImage(${i})">
                            √ó
                        </button>
                    `;
                    document.getElementById('imagePreview').appendChild(container);
                };
                reader.readAsDataURL(file);
            });
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        async function sendMessageWithImages(content) {
            const sendButton = document.getElementById('sendMessage');
            const messageInput = document.getElementById('messageInput');

            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const originalHtml = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;

                // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω?
                if (!stompClient || !stompClient.connected) {
                    alert('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ REST
                    await sendViaRest(content);
                    return;
                }

                // —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ?
                const messageContent = content || (selectedImages.length > 0 ? 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '');
                if (!messageContent.trim() && selectedImages.length === 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }

                // –®–ê–ì 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ß–ï–†–ï–ó REST (–µ—Å–ª–∏ –µ—Å—Ç—å)
                let imageIds = [];
                if (selectedImages.length > 0) {
                    imageIds = await uploadImagesSeparately();
                }

                // –®–ê–ì 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WEBSOCKET
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket:', {
                    eventId: eventId,
                    content: messageContent,
                    imageIds: imageIds
                });

                stompClient.send(
                    `/app/chat/${eventId}/send`,
                    {}, // –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    JSON.stringify({
                        content: messageContent,
                        imageIds: imageIds
                    })
                );

                console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ WebSocket');

                // –®–ê–ì 3: –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                messageInput.value = '';
                document.getElementById('messageCounter').textContent = '0';
                document.getElementById('imagePreview').innerHTML = '';
                selectedImages = [];

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);

                // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ REST
                try {
                    await sendViaRest(content);
                } catch (fallbackError) {
                    console.error('Fallback —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', fallbackError);
                }

            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (sendButton) {
                    sendButton.innerHTML = originalHtml || '<i class="fas fa-paper-plane"></i>';
                    sendButton.disabled = false;
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ REST API
        async function uploadImagesSeparately() {
            const imageIds = [];

            for (let i = 0; i < selectedImages.length; i++) {
                const file = selectedImages[i];

                try {
                    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
                    const formData = new FormData();
                    formData.append('image', file);

                    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${i + 1}/${selectedImages.length}:`, file.name);

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    const response = await fetch(`/api/v1/images/upload?eventId=${eventId}`, {
                        method: 'POST',
                        headers: {
                            // CSRF —Ç–æ–∫–µ–Ω –ë–ï–ó Content-Type –¥–ª—è FormData!
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${errorText}`);
                    }

                    const imageData = await response.json();
                    imageIds.push(imageData.id);
                    console.log(`‚úì –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, ID: ${imageData.id}`);

                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${file.name}:`, error);
                }
            }

            return imageIds;
        }

        // Fallback: –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ REST –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        async function sendViaRest(content) {
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º REST fallback...');

            const messageContent = content || (selectedImages.length > 0 ? 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const response = await fetch('/api/v1/chat?eventId=' + eventId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                },
                body: JSON.stringify({ content: messageContent })
            });

            if (!response.ok) {
                throw new Error('REST –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å');
            }

            const message = await response.json();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ
            if (selectedImages.length > 0) {
                for (const file of selectedImages) {
                    await uploadImageToMessage(message.id, file);
                }
            }

            // –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –¥–æ–±–∞–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ
            return message;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ WebSocket
        function handleWebSocketError(error) {
            console.error('WebSocket –æ—à–∏–±–∫–∞:', error);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.innerHTML = `
        <strong>‚ö†Ô∏è WebSocket –æ—à–∏–±–∫–∞</strong>
        <p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ. –°–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
            document.body.appendChild(errorDiv);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function initializeWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);

                // –û—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                stompClient.debug = null;

                stompClient.connect({}, function(frame) {
                    console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω: ' + frame);

                    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
                    stompClient.subscribe('/topic/chat/' + eventId, function(message) {
                        try {
                            const chatMessage = JSON.parse(message.body);
                            console.log('üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket:', chatMessage);
                            addMessageToChat(chatMessage);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                        }
                    });

                    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
                    stompClient.subscribe('/user/queue/errors', function(message) {
                        const error = JSON.parse(message.body);
                        console.error('–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', error);
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    });

                }, function(error) {
                    console.error('WebSocket –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    handleWebSocketError(error);

                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(initializeWebSocket, 5000);
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket:', error);
                handleWebSocketError(error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º)
        async function loadMessages() {
            try {
                const response = await fetch('/api/v1/chat/' + eventId);
                if (!response.ok) throw new Error('Failed to load messages');

                const data = await response.json();

                // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                const loadingElement = document.getElementById('loadingMessages');
                if (loadingElement) {
                    loadingElement.remove();
                }

                // –ü–æ–ª—É—á–∞–µ–º ID —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∏–∑ Thymeleaf)
                const existingMessageIds = new Set();
                document.querySelectorAll('.message[data-message-id]').forEach(msg => {
                    const id = msg.getAttribute('data-message-id');
                    if (id) existingMessageIds.add(id);
                });

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ API
                if (data.data && data.data.length > 0) {
                    data.data.forEach(message => {
                        if (!existingMessageIds.has(message.id.toString())) {
                            addMessageToChat(message);
                        }
                    });
                }

                // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤–æ–æ–±—â–µ (–Ω–∏ –æ—Ç Thymeleaf, –Ω–∏ –æ—Ç API)
                const messagesContainer = document.getElementById('messagesList');
                if (messagesContainer.children.length === 0) {
                    messagesContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                console.error('Error loading additional messages:', error);
                // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(message) {
            const messagesList = document.getElementById('messagesList');
            const isOwn = message.author === currentUsername;

            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            const loadingElement = document.getElementById('loadingMessages');
            if (loadingElement) {
                loadingElement.remove();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (messagesList.innerHTML.includes('empty-state')) {
                messagesList.innerHTML = '';
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwn ? 'own' : 'other'}`;

            let imagesHtml = '';
            if (message.images && message.images.length > 0) {
                imagesHtml = '<div class="message-images mt-2">' +
                    message.images.map(img =>
                        `<img src="${img.url}" class="chat-image" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-right: 5px;">`
                    ).join('') +
                    '</div>';
            }

            messageElement.innerHTML = `
                <div class="message-header">
                    <strong>${message.author}</strong>
                    <span class="ms-2">${new Date(message.createdAt).toLocaleString()}</span>
                    ${message.edited ? '<small class="ms-2">(—Ä–µ–¥.)</small>' : ''}
                </div>
                <div class="message-content">${message.content}</div>
                ${imagesHtml}
            `;

            messagesList.appendChild(messageElement);
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
        document.getElementById('messageInput').addEventListener('input', function() {
            document.getElementById('messageCounter').textContent = this.value.length;
        });

        async function loadTasks() {
            try {
                const response = await fetch('/api/v1/task/' + eventId);
                if (!response.ok) throw new Error('Failed to load tasks');

                const tasks = await response.json();
                updateTasksList(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksList').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</div>';
            }
        }

        function updateTasksList(tasks) {
            const tasksList = document.getElementById('tasksList');

            if (!tasks || tasks.length === 0) {
                tasksList.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
                return;
            }

            tasksList.innerHTML = '';

            tasks.forEach(task => {
                const isCreator = task.creator === currentUsername;
                const isAssigned = task.assignedUserId === currentUserId;
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskElement.setAttribute('data-creator', task.creator);
                taskElement.setAttribute('data-assigned-user', task.assignedUserId || '');
                taskElement.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-medium">${task.description}</div>
                        <small class="text-muted">
                            –°–æ–∑–¥–∞–ª: ${task.creator}
                            ${task.assignedUser ? '‚Üí ' + task.assignedUser : ''}
                        </small>
                    </div>
                    <div class="item-actions">
                        <input type="checkbox" class="form-check-input task-complete"
                               ${task.completed ? 'checked' : ''}
                               data-task-id="${task.id}">
                        ${isCreator ? `
                        <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="${task.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                tasksList.appendChild(taskElement);
            });
        }

        // –°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π
        async function loadChecklist() {
            try {
                const response = await fetch('/api/v1/checklist/' + eventId);
                if (!response.ok) throw new Error('Failed to load checklist');

                const checklist = await response.json();
                updateChecklistList(checklist);
            } catch (error) {
                console.error('Error loading checklist:', error);
                document.getElementById('checklistList').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</div>';
            }
        }

        function updateChecklistList(checklist) {
            const checklistList = document.getElementById('checklistList');

            if (!checklist || checklist.length === 0) {
                checklistList.innerHTML = '<div class="empty-state">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            checklistList.innerHTML = '';

            checklist.forEach(item => {
                const isCreator = item.createdBy === currentUsername;
                const isAssigned = item.assignedUser === currentUsername;
                const itemElement = document.createElement('div');
                itemElement.className = `checklist-item ${item.completed ? 'completed' : ''}`;
                itemElement.setAttribute('data-creator', item.createdBy);
                itemElement.setAttribute('data-assigned-user', item.assignedUser || '');
                itemElement.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-medium">${item.name} <span class="badge bg-secondary">${item.quantity}x</span></div>
                        ${item.description ? `<small class="text-muted">${item.description}</small><br>` : ''}
                        <small class="text-muted">
                            –î–æ–±–∞–≤–∏–ª: ${item.createdBy}
                            ${item.assignedUser ? '‚Üí ' + item.assignedUser : ''}
                        </small>
                    </div>
                    <div class="item-actions">
                        <input type="checkbox" class="form-check-input item-complete"
                               ${item.completed ? 'checked' : ''}
                               data-item-id="${item.id}">
                        ${isCreator ? `
                        <button class="btn btn-sm btn-outline-danger delete-item" data-item-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                checklistList.appendChild(itemElement);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤
        async function loadTemplates() {
            try {
                const response = await fetch('/api/v1/public/templates');
                if (!response.ok) throw new Error('Failed to load templates');

                const templates = await response.json();
                displayTemplates(templates);
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤</div>';
            }
        }

        function displayTemplates(templates) {
            const templatesList = document.getElementById('templatesList');

            if (!templates || templates.length === 0) {
                templatesList.innerHTML = '<div class="empty-state">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</div>';
                return;
            }

            templatesList.innerHTML = '';

            templates.forEach(template => {
                const templateElement = document.createElement('div');
                templateElement.className = 'card mb-3';
                templateElement.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">${template.name}</h6>
                        <p class="card-text text-muted">${template.description || ''}</p>
                        <small class="text-muted">–≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${template.items ? template.items.length : 0}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success apply-template" data-template-id="${template.id}">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
                            </button>
                        </div>
                    </div>
                `;
                templatesList.appendChild(templateElement);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const filter = this.getAttribute('data-filter');
                    filterItems(type, filter);
                });
            });

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-complete')) {
                    toggleTaskCompletion(e.target.getAttribute('data-task-id'));
                }
                if (e.target.classList.contains('item-complete')) {
                    toggleItemCompletion(e.target.getAttribute('data-item-id'));
                }
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-task')) {
                    const taskId = e.target.closest('.delete-task').getAttribute('data-task-id');
                    deleteTask(taskId);
                }
                if (e.target.closest('.delete-item')) {
                    const itemId = e.target.closest('.delete-item').getAttribute('data-item-id');
                    deleteChecklistItem(itemId);
                }
                if (e.target.closest('.apply-template')) {
                    const templateId = e.target.closest('.apply-template').getAttribute('data-template-id');
                    applyTemplate(templateId);
                }
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function filterItems(type, filter) {
            const items = document.querySelectorAll(`.${type}-item`);

            items.forEach(item => {
                const isCreator = item.getAttribute('data-creator') === currentUsername;
                const isAssigned = item.getAttribute('data-assigned-user') === currentUserId.toString();
                const isCompleted = item.classList.contains('completed');

                let show = false;

                switch (filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'my':
                        show = isCreator || isAssigned;
                        break;
                    case 'active':
                        show = !isCompleted;
                        break;
                }

                item.style.display = show ? 'flex' : 'none';
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
            document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏
        async function addTask() {
            const form = document.getElementById('taskForm');
            const description = form.querySelector('[name="description"]').value.trim();
            const assignedUserId = form.querySelector('[name="assignedUserId"]').value;

            if (!description) {
                alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }

            try {
                const response = await fetch('/api/v1/task?eventId=' + eventId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        description: description,
                        assignedUserId: assignedUserId || null
                    })
                });

                if (response.ok) {
                    $('#addTaskModal').modal('hide');
                    form.reset();
                    await loadTasks();
                    alert('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create task');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + error.message);
            }
        }

        async function toggleTaskCompletion(taskId) {
            try {
                const response = await fetch('/api/v1/task/' + taskId + '/toggle', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    }
                });

                if (response.ok) {
                    await loadTasks();
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
        }

        async function deleteTask(taskId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                try {
                    await fetch('/api/v1/task/' + taskId, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        }
                    });
                    await loadTasks();
                    alert('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–µ—â–µ–π
        async function addChecklistItem() {
            const form = document.getElementById('checklistForm');
            const name = form.querySelector('[name="name"]').value.trim();
            const description = form.querySelector('[name="description"]').value.trim();
            const quantity = form.querySelector('[name="quantity"]').value;
            const assignedUserId = form.querySelector('[name="assignedUserId"]').value;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
                return;
            }

            try {
                const response = await fetch('/api/v1/checklist?eventId=' + eventId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        quantity: parseInt(quantity) || 1,
                        assignedUserId: assignedUserId || null
                    })
                });

                if (response.ok) {
                    $('#addChecklistModal').modal('hide');
                    form.reset();
                    await loadChecklist();
                    alert('–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create checklist item');
                }
            } catch (error) {
                console.error('Error adding checklist item:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + error.message);
            }
        }

        async function toggleItemCompletion(itemId) {
            try {
                const response = await fetch('/api/v1/checklist/' + itemId + '/toggle', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    }
                });

                if (response.ok) {
                    await loadChecklist();
                }
            } catch (error) {
                console.error('Error toggling item:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
            }
        }

        async function deleteChecklistItem(itemId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞?')) {
                try {
                    await fetch('/api/v1/checklist/' + itemId, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        }
                    });
                    await loadChecklist();
                    alert('–≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!');
                } catch (error) {
                    console.error('Error deleting item:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
                }
            }
        }

        async function applyTemplate(templateId) {
            if (!confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω? –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/public/templates/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        eventId: eventId
                    })
                });

                if (response.ok) {
                    $('#templatesModal').modal('hide');
                    await loadChecklist();
                    alert('–®–∞–±–ª–æ–Ω —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to apply template');
                }
            } catch (error) {
                console.error('Error applying template:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞: ' + error.message);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(message) {
            const messagesList = document.getElementById('messagesList');
            const isOwn = message.author === currentUsername;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const existingMessage = messagesList.querySelector(`[data-message-id="${message.id}"]`);
            if (existingMessage) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                existingMessage.querySelector('.message-content').textContent = message.content;
                return;
            }

            // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (messagesList.innerHTML.includes('empty-state')) {
                messagesList.innerHTML = '';
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwn ? 'own' : 'other'}`;
            messageElement.setAttribute('data-message-id', message.id);

            let imagesHtml = '';
            if (message.images && message.images.length > 0) {
                imagesHtml = '<div class="message-images mt-2">' +
                    message.images.map(img =>
                        `<div class="d-inline-block me-2 mb-2">
                    <a href="${img.url}" target="_blank">
                        <img src="${img.url}" class="img-thumbnail"
                             alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                             style="max-width: 200px; max-height: 150px;">
                    </a>
                </div>`
                    ).join('') +
                    '</div>';
            }

            messageElement.innerHTML = `
        <div class="message-header">
            <strong>${message.author}</strong>
            <span class="ms-2">${new Date(message.createdAt).toLocaleString()}</span>
            ${message.edited ? '<small class="ms-2">(—Ä–µ–¥.)</small>' : ''}
        </div>
        <div class="message-content">${message.content}</div>
        ${imagesHtml}
    `;

            messagesList.appendChild(messageElement);
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        /* –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å —á–∞—Ç –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        document.addEventListener('DOMContentLoaded', function() {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            setTimeout(function() {
                const chatContainer = document.getElementById('chatMessages');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 100);

        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
        function scrollChatToBottom() {
            const chatContainer = document.getElementById('messagesList');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    </script>

    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
</div>
</body>
</html>